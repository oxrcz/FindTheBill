
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find The Bill - Bill Details</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        nav {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        nav a {
            color: #0066cc;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        nav a:hover {
            color: #004999;
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        #historyContainer {
            max-width: 800px;
            margin: 0 auto;
        }

        .history-item {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .history-item:hover {
            transform: translateY(-2px);
        }

        .no-history {
            text-align: center;
            color: #6c757d;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #map {
            height: 250px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav>
        <a href="/">Home</a>
        <a href="/most_tracked_bills">Most Tracked Bills</a>
        <a href="/most_tracked_cities">Most Tracked Cities</a>
        <a href="/about">About</a>
    </nav>

    <h1 id="billSerial"></h1>
    <div id="historyContainer"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        function initMap(locations) {
            const map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            if (locations && locations.length > 0) {
                const markers = locations.map(location => {
                    if (location.lat && location.lng) {
                        return L.marker([location.lat, location.lng])
                            .bindPopup(`${location.city}, ${location.state}`)
                            .addTo(map);
                    }
                    return null;
                }).filter(marker => marker !== null);

                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pathParts = window.location.pathname.split('/');
            const serialNumber = pathParts[pathParts.length - 1];

            if (!serialNumber) {
                window.location.href = '/';
                return;
            }

            document.getElementById('billSerial').textContent = `Bill Serial: ${serialNumber}`;

            // Create map container
            const mapDiv = document.createElement('div');
            mapDiv.id = 'map';
            document.getElementById('historyContainer').appendChild(mapDiv);

            fetch(`/api/bill/${serialNumber}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Bill not found');
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('historyContainer');
                    
                    // Add bill value, tracking count and cooldown timer
                    const infoDiv = document.createElement('h2');
                    infoDiv.textContent = `Value: $${data.billValue} | Times Tracked: ${data.trackedCount}`;
                    container.insertBefore(infoDiv, mapDiv);

                    if (data.cooldownSeconds > 0) {
                        const cooldownDiv = document.createElement('div');
                        cooldownDiv.className = 'message';
                        cooldownDiv.style.backgroundColor = '#e9ecef';
                        cooldownDiv.style.padding = '15px';
                        cooldownDiv.style.marginBottom = '20px';
                        cooldownDiv.style.borderRadius = '8px';
                        cooldownDiv.style.textAlign = 'center';
                        container.insertBefore(cooldownDiv, mapDiv);

                        let remainingSeconds = data.cooldownSeconds;
                        const updateTimer = () => {
                            const minutes = Math.floor(remainingSeconds / 60);
                            const seconds = remainingSeconds % 60;
                            cooldownDiv.textContent = `This bill is taking a quick break! You can track it again in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                            if (remainingSeconds <= 0) {
                                cooldownDiv.style.display = 'none';
                            }
                            remainingSeconds--;
                        };
                        updateTimer();
                        const timer = setInterval(updateTimer, 1000);
                    }

                    if (data.trackedHistory && data.trackedHistory.length > 0) {
                        // Initialize map with locations
                        initMap(data.trackedHistory);

                        // Create history list
                        const historyList = document.createElement('div');
                        data.trackedHistory.forEach(entry => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            const timestamp = new Date(entry.timestamp);
                            historyItem.textContent = `Location: ${entry.city}, ${entry.state} - ${timestamp.toLocaleDateString()} ${timestamp.toLocaleTimeString()}`;
                            historyList.appendChild(historyItem);
                        });
                        container.appendChild(historyList);
                    } else {
                        container.innerHTML = '<div class="no-history">No tracking history found for this bill.</div>';
                    }
                })
                .catch(error => {
                    const container = document.getElementById('historyContainer');
                    container.innerHTML = `<div class="no-history">Error: ${error.message}</div>`;
                });
        });
    </script>
</body>
</html>
